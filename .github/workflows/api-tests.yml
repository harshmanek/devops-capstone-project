name: API Integration Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: "0 12 * * *" # Daily at noon UTC

jobs:
  api-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      DATABASE_URL: mysql+pymysql://devops_user:devops_password_123@127.0.0.1:3306/microservices_db
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password_123
          MYSQL_DATABASE: microservices_db
          MYSQL_USER: devops_user
          MYSQL_PASSWORD: devops_password_123
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask flask-sqlalchemy pymysql python-dotenv gunicorn werkzeug requests

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysql -h 127.0.0.1 -u devops_user -pdevops_password_123 -e "SELECT 1" && break
            sleep 1
          done

      - name: Start User Service
        run: |
          mkdir -p ./logs
          cd services/user-service
          export SQLALCHEMY_DATABASE_URI="mysql+pymysql://devops_user:devops_password_123@127.0.0.1:3306/microservices_db"
          nohup python app.py > ../../logs/user-service.log 2>&1 & echo $! > ../../logs/user-service.pid
          for i in {1..30}; do curl -sS http://localhost:5001/health && break || (echo "waiting for user-service..." && sleep 1); done
          tail -n 50 ../../logs/user-service.log || true

      - name: Start Product Service
        run: |
          mkdir -p ./logs
          cd services/product-service
          export SQLALCHEMY_DATABASE_URI="mysql+pymysql://devops_user:devops_password_123@127.0.0.1:3306/microservices_db"
          nohup python app.py > ../../logs/product-service.log 2>&1 & echo $! > ../../logs/product-service.pid
          for i in {1..30}; do curl -sS http://localhost:5002/health && break || (echo "waiting for product-service..." && sleep 1); done
          tail -n 50 ../../logs/product-service.log || true

      - name: Start Order Service
        run: |
          mkdir -p ./logs
          cd services/order-service
          export SQLALCHEMY_DATABASE_URI="mysql+pymysql://devops_user:devops_password_123@127.0.0.1:3306/microservices_db"
          nohup python app.py > ../../logs/order-service.log 2>&1 & echo $! > ../../logs/order-service.pid
          for i in {1..30}; do curl -sS http://localhost:5003/health && break || (echo "waiting for order-service..." && sleep 1); done
          tail -n 50 ../../logs/order-service.log || true

      - name: Health Check
        run: |
          sleep 2
          curl -f http://localhost:5001/health || exit 1
          curl -f http://localhost:5002/health || exit 1
          curl -f http://localhost:5003/health || exit 1
          echo "âœ“ All services healthy"

      - name: Dump service logs on failure
        if: failure()
        run: |
          echo "=== user-service log ==="
          tail -n 200 ./logs/user-service.log || true
          echo "=== product-service log ==="
          tail -n 200 ./logs/product-service.log || true
          echo "=== order-service log ==="
          tail -n 200 ./logs/order-service.log || true

      - name: Run comprehensive tests
        run: |
          bash test_all_services.sh

      - name: Dump service logs on failure
        if: failure()
        run: |
          echo "=== user-service log ==="
          tail -n 200 ./logs/user-service.log || true
          echo "=== product-service log ==="
          tail -n 200 ./logs/product-service.log || true
          echo "=== order-service log ==="
          tail -n 200 ./logs/order-service.log || true
